language: node_js
os: linux
node_js:
  - '12'
# keep the npm cache around to speed up installs
cache:
  directories:
    - '$HOME/.npm'
jobs:
  include:
    - stage: testing
      if: branch in (master, dev)
      script: # if this is not set, it will run npm run test
        - npm ci
        - npm run test:unit
        - npm run build:lib
      after_success: # after test is run
        - cat ./coverage/lcov.info | coveralls
    - stage: npm release
      # only release on master branch with specific commit message (generated by npm version)
      if: branch = master AND commit_message =~ /^[0-9]*\.[0-9]*\.[0-9]*$/
      before_deploy:
        - npm run build:lib
      deploy:
        provider: npm
        api_key: '$NPM_TOKEN'
        email: '$NPM_EMAIL'
        skip_cleanup: true
